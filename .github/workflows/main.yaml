name: Deploy to Azure VM

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set up SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H 13.90.212.249 >> ~/.ssh/known_hosts

      - name: Deploy to Azure VM
        run: |
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa azureuser@13.90.212.249 << 'EOF'
          set -e

          echo "✅ Updating system & installing dependencies..."
          sudo apt update
          sudo apt install -y python3 python3-pip python3-venv git ufw

          echo "✅ Cloning/Pulling Repository..."
          mkdir -p ~/app
          cd ~/app
          if [ ! -d .git ]; then
            git clone https://***@github.com/Ayeesha208/three-tier-architecture-demo.git .
          else
            git pull origin main
          fi

          echo "✅ Setting up Python environment..."
          python3 -m venv venv
          source venv/bin/activate
          pip install --upgrade pip
          pip install gunicorn flask

          echo "✅ Configuring systemd service..."
          sudo bash -c 'cat > /etc/systemd/system/myapp.service <<EOF2
          [Unit]
          Description=Gunicorn instance to serve my Python app
          After=network.target

          [Service]
          User=azureuser
          Group=www-data
          WorkingDirectory=/home/azureuser/app
          ExecStart=/home/azureuser/app/venv/bin/gunicorn --workers 3 --bind 0.0.0.0:5000 app:app
          Restart=always

          [Install]
          WantedBy=multi-user.target
          EOF2'

          echo "✅ Restarting service..."
          sudo systemctl daemon-reload
          sudo systemctl enable myapp.service
          sudo systemctl restart myapp.service

          echo "✅ Opening port 5000..."
          sudo ufw allow 5000/tcp
          sudo ufw reload

          echo "✅ Deployment Complete!"
          EOF
